<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
    .srt-line { background-color: black; padding: 3pt; font-size: 17pt; font-family: sans-serif; }
    .srt-line div { width: 50%; display: inline-block; color: white; vertical-align: top; }
    .srt-line.sel { background-color: #222; }
    .hidden { display: none; }
    button, input { padding: 3pt 10pt; font-size: 14pt; }
    input { padding: 3pt 3pt; }
</style>

<script src="jquery-2.2.4.min.js"></script>
<script src="freq-20k.js"></script>
<script src="lemmas.js"></script>

</head>

<body>
  <div class="wrapper">
    <div style=" margin-top: -200pt; position: fixed; background-color: white; width: 100%; "><img class="snapshot" style=" max-height: 200pt; "/></div>
    <div class="srt-box" style=" width: 850pt; margin-top: 200pt; ">
  </div>
  </div>
<script>
    (function () {
    
    freqDicClick(".srt-line.sel", ".wrapper");
    
    var path = $(location).attr("href").match(/[?&]path=([^&]+)/)[1];
    var videosPath = "/videos/" + path;
    var keys = $(document).find("[key]").toArray().map(x => Number($(x).attr("key")));
    var ens;
    var rus;
   
    fetch(videosPath + ".eng.srt")
        .then((res) => res.text())
        .then((text) => {
            ens = text;
            fetch(videosPath + ".rus.srt")
                .then((res) => res.text())
                .then((text) => {
                    rus = text;
                    handleSrt();
                });
        });

    function applySnapshot(name) {
        $(".snapshot").attr("src", `bins/snapshots/${path}/${name}.jpg`);
    }
        
    function handleSrt() {
        ens = ens.split(/\r?\n\r?\n/).map(x => x.split(/\r?\n/)).filter(x => x.length > 2);
        rus = rus.split(/\r?\n\r?\n/).map(x => x.split(/\r?\n/)).filter(x => x.length > 2);
        var hs = [];
        for (var i = 0; i < ens.length; i++) {
            var en = ens[i];
            var ru = rus[i];
            var t = en[1].split(/ ?--> ?/)[0];
            var ts = (t + ",0").split(/[:\.,]/);
            for (var j = 0; j <= 3; j++) {
                ts[j] = j <= 2 ? ts[j].padStart(2, "0") : ts[j].padEnd(2, "0").substr(0,2);
            }
            var name = ts.slice(0,4).join("_");
            if (i === 0) { applySnapshot(name); }
            en = en.slice(2).join("<br/>");
            ru = ru.slice(2).join("<br/>");
            hs.push(`<div class="srt-line" data-name="${name}"><div>${en}</div><div>${ru}</div></div>`);
        }
        $(".srt-box").html(hs.join(""));
        $(".srt-line:first").addClass("sel");        
    };

    $(document).on("click", ".srt-line", function () {
        $(".srt-line.sel").removeClass("sel");
        $(this).addClass("sel");
        applySnapshot($(this).data("name"));
    });
    
    })();
</script>
</body>
</html>
