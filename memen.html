<HEAD>

<meta charset="utf-8">
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="freq-20k.js"></script>
<script src="prons.js"></script>
<style>
  table { border-collapse: collapse; }
  input, button, td, label, textarea, .word-retell, select, .dic-item, .ctx-item, .ctx-msg, .ctx-retell { padding: 5pt; font-size: 14pt; margin-top: 5pt; }
  textarea { width: 100%; }
  input[type=checkbox] { transform: scale(1.7); font-size: 14pt; margin-top: 10pt; }
  .hidden { display: none; }
  .x-large { font-size: 20pt; }
  .xx-large { font-size: 14pt; }
  .ctx-item.sel { background-color: #DDF; }

    .wrapper-all .word-retell
  , .wrapper-hot .word-retell
  , .wrapper-hot .search-wrapper
  , .wrapper-hot .dic
  , .wrapper-retell .search-wrapper
  , .wrapper-retell .word-index 
  , .wrapper-retell .word-form
  , .wrapper-retell .dic
  { display: none; }

  .word-item.sel { background-color: #DDF; }
  .search-wrapper, .word-index, .word-form, .word-retell { margin-top: 10pt; }
  .save-btn { margin-top: 20pt; }
  .word-item { cursor: pointer; }
</style>

</HEAD>

<BODY>
<div class="backup-alert hidden" style=" font-size: 16pt; color: red; ">backup alert</div>
<div class="wrapper wrapper-all">
  <div>
    <label><input type="radio" name="view" value="all" checked/>all</label>
    <label><input type="radio" name="view" value="hot"/>hot</label>
    <label><input type="radio" name="view" value="retell"/>retell</label>
  </div>
  
  <div class="search-wrapper">
    <input class="search-box" name="search" type="text"/><div class="clear-btn" style=" display: inline-block; width: 23pt; margin-left: -23pt; font-size: 16pt; ">&nbsp;&nbsp;×</div>
    <button class="search-btn">Search</button>
    <button class="create-btn">Create</button>
  </div>
  
  <div class="word-index"></div>
  
  <div class="word-form">
    <input name="key"  type="hidden"/>
    <input name="src" type="text"/><br/>
    <input name="pron" type="text" placeholder="произношение"/><br/>
    <select name="type">
      <option value="артикль">артикль</option>
      <option value="глагол">глагол</option>
      <option value="местоимение">местоимение</option>
      <option value="наречие">наречие</option>
      <option value="предлог">предлог</option>
      <option value="прилагательное">прилагательное</option>
      <option value="союз">союз</option>
      <option value="существительное">существительное</option>
      <option value="числительное">числительное</option>
      <option value="междометие">междометие</option>
      <option value="определитель">определитель</option>
      <option value="прочее">прочее</option>
    </select><br/>
    <input name="val" type="text"  placeholder="перевод"/><br/>
    <select name="status">
      <option value="hot">hot</option>
      <option value="retell">retell</option>
    </select><br/>
    <input name="retell" type="hidden"/>
    <input name="ctxNum"  type="hidden"/>
    <input name="retell-hours" readonly> <button class="retell-reset">reset</button></br>
    <textarea name="context" rows="6"></textarea></br>
    <button class="save-btn">Save</button> 
  </div>
  <div class="dic"></div>
  <div class="ctx-wrapper hidden">
    <button class="ctx-btn">Past</button>
    <div class="ctx"></div>
  </div>
  <div class="word-retell">
    <button class="hint-btn" data-level="0">Hint</button>
    <div class="word-retell-body"></div>
    <button class="retell-btn" data-hours="0">&nbsp;0h&nbsp;</button>
    <button class="retell-btn" data-hours="2">&nbsp;2h&nbsp;</button>
    <button class="retell-btn" data-hours="6">&nbsp;6h&nbsp;</button>
    <button class="retell-btn" data-hours="21">&nbsp;1d&nbsp;</button>
    <button class="retell-btn" data-hours="45">&nbsp;2d&nbsp;</button>
    <button class="retell-btn" data-hours="69">&nbsp;3d&nbsp;</button>
    <button class="retell-btn" data-hours="117">&nbsp;5d&nbsp;</button>
    <button class="retell-btn" data-hours="189">&nbsp;8d&nbsp;</button>
    <button class="retell-btn" data-hours="307">13d</button>
    <button class="retell-btn" data-hours="100000">INF</button>
  </div>
</div>
  
<script>
var ver = 2;
var words = [];
var word;
var wordRetell;
var lastBackup = Date.now();

(function () {
    $.ajax({
        url: "http://192.168.0.2/sandbox/api/memen/lastbackup"
    }).done(function(d) {
        lastBackup = (new Date(d)).valueOf();
        if (Date.now() - lastBackup > 3600000 * 24 * 2) {
            $(".backup-alert").removeClass("hidden");
        }
    });
})();

(function() {
    var req = indexedDB.open("memen", ver);
    
    req.onupgradeneeded = function(event) {
        var db = event.target.result;
        var words;
        
        if (!db.objectStoreNames.contains("words")) {
            words = db.createObjectStore("words", {keyPath: "key"});
        }
        else {
            words = event.target.transaction.objectStore("words");
        }
      
        if (!words.indexNames.contains("status")) {
            words.createIndex("status", "status", { unique: false });
        }
        
        if (!words.indexNames.contains("retell")) {
            words.createIndex("retell", "retell", { unique: false });
        }
        
        if (!words.indexNames.contains("src")) {
            words.createIndex("src", "src", { unique: false });
        }
    };
})();

function guid() {
  return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
    (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
  );
}

function index() {
    var wrapper = $(".wrapper");
    if (wrapper.hasClass("wrapper-all")) {
        search();
    }
    else if (wrapper.hasClass("wrapper-hot")) {
        hot();
    }
}

function put(word, notExists) {
    var req = indexedDB.open("memen", ver);
    
    req.onsuccess = function(event) {
        var db = event.target.result;
        var tx = db.transaction("words", "readwrite");
        if (notExists) {
            tx.objectStore("words").add(word).onsuccess = function() {
                index();
            }
        }
        else {
            tx.objectStore("words").put(word).onsuccess = function() {
                index();
            }
        }
        backup();
    }
}

function search() {
    var s = $(".search-box").val();
    if (freqDic && freqDic.length > 0 && freqDic[0].key) {
        var dicS = s.toLowerCase().replaceAll(/[^a-z]/g, "");
        var dicHtml = !s ? "" : freqDic.filter(x => x.key.indexOf(dicS) === 0).slice(0,10).map(x => `<div class="dic-item">${x.value}</div>`).join("");
        $(".dic").html(dicHtml);
        $(".ctx-wrapper").addClass("hidden");
    }
    
    var req = indexedDB.open("memen", ver);
    req.onsuccess = function(event) {
        var db = event.target.result;
        var tx = db.transaction("words", "readonly");
        var range = IDBKeyRange.bound(s, s + "~", false, true);
        var req = tx.objectStore("words").index("src").getAll(range, 10);
        req.onsuccess = function() {
            words = req.result;
            var index = 0;
            if (word)
                words.forEach((x,i) => { if (x.key === word.key) index = i; });
            word = words.length > 0 ? words[index] : null;
            wordsHtml(index);
            wordToForm();
        };
    }
}

function hot() {
    var req = indexedDB.open("memen", ver);
    
    req.onsuccess = function(event) {
        var db = event.target.result;
        var tx = db.transaction("words", "readonly");
        var req = tx.objectStore("words").index("status").getAll("hot");
        req.onsuccess = function() {
            words = req.result;
            var index = 0;
            if (word)
                words.forEach((x,i) => { if (x.key === word.key) index = i; });
            word = words.length > 0 ? words[index] : null;
            wordsHtml(index);
            wordToForm();
        };
    }
}

function del(key) {
    var req = indexedDB.open("memen", ver);
    
    req.onsuccess = function(event) {
        var db = event.target.result;
        var tx = db.transaction("words", "readwrite");
        tx.onerror = function (event) { console.log(event); }
        req = tx.objectStore("words").delete(key);
        req.onsuccess = function() {
            index();
        }
    }
}

function retell() {
    var req = indexedDB.open("memen", ver);
    
    req.onsuccess = function(event) {
        var db = event.target.result;
        var tx = db.transaction("words", "readonly");
        var range = IDBKeyRange.upperBound((new Date).valueOf(), true);
        var req = tx.objectStore("words").index("retell").getAll(range);
        req.onsuccess = function() {
            var words = req.result.filter(x => x.status === "retell");
            wordRetell = words.length > 0 ? words[0] : null;
            $(".retell-level-btn").data("level", 0);
            wordRetellHtml(0);
        };
    }
}

function wordsHtml(index) {
    if (!Number.isInteger(index))
        index = 0;
    $(".word-index").html(`<table>${words.map((x, i) => `<tr class="word-item${i === index ? " sel" : ""}" data-i="${i}"><td><b>${x.src}</b></td><td>${x.pron ? `[${x.pron}]` : ""}</td><td>${x.val}</td></tr>`).join("")}</table>`);
}

function wordRetellHtml(level) {
    $(".hint-btn").data("level", level);
    if (!wordRetell) {
        $(".word-retell-body").html("");
        return;
    }
    var rs = [];
    var c = wordRetell.context.split(/\r?\n/).filter(x => x !== "");
    if (c.length !== 0) {
        var s = c[wordRetell.ctxNum].split(/ ?\| ?/);
        rs.push(`<div class="ctx-retell">${s[0]}</div>`);
        if (level > 0) {
            rs.push(`<div class="ctx-retell">${s[1]}</div>`);
        }
    }
    
    rs.push(`<div class="x-large"><b>${wordRetell.src}</b>${wordRetell.pron ? ` [${wordRetell.pron}]` : ""}${ wordRetell.type === "прочее" ?  "" : " {" + wordRetell.type + "}" }</div>`);
    if (level > 0) {
        rs.push(`<div class="x-large">${wordRetell.val}</div>`);
    }
    $(".word-retell-body").html(rs.join(""));
}

function wordToForm() {
    if (!word) {
        $(".word-form").addClass("hidden");
        return;
    }
    else {
        $(".word-form").removeClass("hidden");
    }
    $('[name=key]').val(word.key);
    $('[name=src]').val(word.src);
    $('[name=type]').val(word.type);
    $('[name=pron]').val(word.pron);
    $('[name=val]').val(word.val);
    $('[name=status]').val(word.status);
    $('[name=retell]').val(word.retell);
    var retellHours = Math.round((word.retell - Date.now().valueOf()) / 3600000);
    $('[name=retell-hours]').val( Math.abs(retellHours) < 1000 ? `${retellHours}h` : "");
    $('[name=context]').val(word.context);
    $('[name=ctxNum]').val(word.ctxNum);    
}

function wordFromForm() {
    var pron = $("[name=pron]").val()
        .replaceAll(/dh/ig, "ð")
        .replaceAll(/th/ig, "θ")
        .replaceAll(/ng/ig, "ŋ");
    word = {
        key: $('[name=key]').val(),
        src: $('[name=src]').val(),
        type: $('[name=type]').val(),
        pron: pron,
        val: $('[name=val]').val(),
        status: $('[name=status]').val(),
        context: $('[name=context]').val(),
        retell: Number($('[name=retell]').val()),
        ctxNum: Number($('[name=ctxNum]').val())
    };
}

function getPron(s) {
    return s.split(/[^\w]+/).map(x => prons.get(x)).filter(x => x).join(" ");
}

function backup() {
    if (Date.now() - lastBackup < 3600000 || !window.location.href.includes("192.168.0.4"))
        return;

    lastBackup = Date.now();
    var upperYear = (new Date()).getFullYear() + 5;
    var upperTime = (new Date(upperYear,0,1)).valueOf();
    indexedDB.open("memen", ver).onsuccess = function(event) {
        var db = event.target.result;
        var tx = db.transaction("words", "readonly");
        var range = IDBKeyRange.upperBound(upperTime, true);
        var req = tx.objectStore("words").index("retell").getAll(range);
        req.onsuccess = function() {
            var body = "=" + JSON.stringify(req.result);
            $.ajax({
                url: "http://192.168.0.2/sandbox/api/memen/backup"
              , method: "post"
              , data: body
            });
        };
    }
}

$(".search-btn").click(function() {
    search();
});

$(".migrate-btn").click(function() {
    var req = indexedDB.open("memen", ver);
    req.onsuccess = function(event) {
        var db = event.target.result;
        var tx = db.transaction("words", "readonly");
        var req = tx.objectStore("words").getAll();
        req.onsuccess = function() {
            var words = req.result.filter(w => !/([0-9a-f]+-){5}/.test(w.key + "-"));
            words.forEach(w => {
                var oldKey = w.key;
                w.src = w.key;
                w.key = guid();
                w.ctxNum = 0;
                put(w, true);
                del(oldKey);
            });
        };
    };
});

$('[name="view"]').on("change", function() {
    var view = $(this).val();
    $(".wrapper").attr("class", `wrapper wrapper-${view}`);
    switch (view) {
        case "all":
        search();
        break;
        
        case "hot":
        hot();
        break;

        case "retell":
        retell();
        break;
    };
});

$(document).on("click", ".word-item", function() {
    $(".word-item").removeClass("sel");
    $(this).addClass("sel");
    var i = Number($(this).data("i"));
    word = words[i];
    wordToForm();
});

$(".save-btn").click(function() {
    wordFromForm();
    if (!word.src) {
        del(word.key);
    }
    if (word.src) {
        put(word);
    }
});

$(".create-btn").click(function() {
    var s = $(".search-box").val();
    if (!s)
        return;
    var src = $(".search-box").val();
    word = {
        key: guid()
      , src: src
      , type: "прочее"
      , pron: getPron(src)
      , val: ""
      , status: "hot"
      , ctxNum: 0
      , retell: Date.now().valueOf()
    };
    put(word, true);
});

$(".hint-btn").click(function() {
    var level = Number($(this).data("level")) + 1;
    if (level === 1 && !wordRetell.context) {
        level = 2;
    }
    $(this).data("level", level);
    wordRetellHtml(level);
});

$(".retell-btn").click(function() {
    wordRetell.retell = Date.now().valueOf() + Number($(this).data("hours")) * 3600000;
    wordRetell.ctxNum = (wordRetell.ctxNum + 1) % wordRetell.context.split(/\r?\n/).length;
    put(wordRetell);
    retell();
});

$(".retell-reset").click(function() {
    $("[name=retell]").val(Date.now());
    $("[name=retell-hours]").val("0h");
});

$(".clear-btn").click(function() {
    $("[name=search]").val("");
    $("[name=search]").focus();
});

$(document).on("click", ".dic-item", function() {
    var s = $(this).text();
    var n = s.substr(0,2);
    var key = s.split("{")[0] + "{";
    $.ajax({
        url: `conen/${n}.txt`
    }).done(function(d) {
        var ss = d.split(/\r\n/);
        var i = 0;
        var rs = [];
        for (; i < ss.length && !(ss[i].indexOf(key) === 0); i++);
        i++;
        for (; i < ss.length && !ss[i].includes("{"); i++) {
            rs.push(ss[i]);
        }
        var html = rs.length === 0 ? `<div class="ctx-msg">Не найдено</div>` : rs.map(x => `<div class="ctx-item">${x}</div>`).join("");
        $(".ctx").html(html);
        $(".ctx-wrapper").removeClass("hidden");
    }).fail(function() {
        $(".ctx").html(`<div class="ctx-msg">Не найдено</div>`);
        $(".ctx-wrapper").removeClass("hidden");
    });
});

$(document).on("click", ".ctx-item", function() {
    $(this).toggleClass("sel");
});

$(".ctx-btn").click(function() {
    var s = $(".ctx-item.sel").get().map(x => $(x).text()).join("\r\n");
    $("[name=context]").val(s);
});

search();

</script>

</BODY>