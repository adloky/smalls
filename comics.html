<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="jquery-2.2.4.min.js"></script>
  <script src="js/knockout-3.5.1.js"></script>
  <script src="js/knockout.mapping.js"></script>
<style>
  * { box-sizing: border-box; }
  body { margin: 0pt; margin-right: 220pt; }
  .panel { width: 220pt; margin-right: -220pt; position: fixed; right: 220pt; padding: 10pt; }
  .page { position: relative; }
  .bub { position: absolute; border: 1px solid transparent; margin: 0px; font-family: 'Comic Sans MS'; line-height: 0.85; padding: 0.2em; }
  .bub.sel { border-color: red; }
  .page { width: 1500px; height: 3000px; }
  input, textarea { margin-bottom: 5pt; font-family: 'Courier New'; }
  input { width: 40pt; }
  .text { width: 100%; height: 100pt; } 
</style>
<head>
<body>
  <div class="panel">
    <!-- ko with: bub -->
    <input data-bind="value: size "/>
    <input data-bind="value: color "/>
    <input data-bind="value: bg "/>
    <br/>
    <input type="radio" name="align" value="left" data-bind="checked: align" style=" width:20pt; " />
    <input type="radio" name="align" value="center" data-bind="checked: align" style=" width:20pt; " />
    <input type="radio" name="align" value="right" data-bind="checked: align" style=" width:20pt; " />
    <input type="checkbox" name="fill" data-bind="checked: fill" style=" width:20pt; " />
    <!-- /ko -->
    <textarea class="text" data-bind="textInput: en, attr: { 'data-id': langBub('en').id }"></textarea>
    <textarea class="text" data-bind="textInput: ru, attr: { 'data-id': langBub('ru').id }"></textarea>
  </div>
  <div style="padding: 10px;"><div class="page">
      <img src="bins/tt/002-001.jpg"/>
      <!-- ko foreach: bubs -->
      <!-- ko if: lang() === $root.lang() -->
      <pre class="bub" draggable="true" data-bind="css: { sel: id() == $root.id() }, attr: { id: id }, text: !text() ? '&nbsp;' : text, style: { left: x() + 'px', top: y() + 'px', 'font-size': size() + 'px', color: color, 'text-shadow': sh, 'text-align': align, 'background-color': !fill() ? 'transparent' : bg() }"></pre>
      <!-- /ko -->
      <!-- /ko -->
  </div></div>
<script>
    function guid() {
        return "10000000100040008000100000000000".replace(/[018]/g, c =>
            (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
        );
    }

    var vm = {};
    vm.bubs = ko.observableArray();
    vm.id = ko.observable();
    //var zBub = createOneBub(0,0,"en");
    
    vm.bub = ko.computed(function() {
        var id = vm.id();
        return vm.bubs().find(x => x.id() === id);
    });
    
    function langBub(lang) {
        var bub = vm.bub();
        var sibId = bub.sib();
        var sib = vm.bubs().find(x => x.id() === sibId);
        return bub.lang() === lang ? bub : sib;
    }    
    
    vm.en = ko.pureComputed({ read: function() {
        return langBub("en").text();
    }, write: function(value) {
        langBub("en").text(value);
    }});

    vm.ru = ko.pureComputed({ read: function() {
        return langBub("ru").text();
    }, write: function(value) {
        langBub("ru").text(value);
    }});

    vm.lang = ko.computed(function() {
        if (!vm.bub()) return "en";
        return vm.bub().lang();
    });
    
    vm.lang.subscribe(function(newValue) {
        vm.id(langBub(newValue).id());
    });

    function bubEx(bub) {
        bub.sh = ko.computed(function() {
            var bg = bub.bg();
            return `-1px -1px 0 ${bg}, 1px -1px 0 ${bg}, -1px 1px 0 ${bg}, 1px 1px 0 ${bg}, -2px 0px 0 ${bg}, 2px 0px 0 ${bg}`
        });
    }
    
    function createOneBub(x, y, lang) {
        var self = {};
        self.id = ko.observable(guid());
        self.lang = ko.observable(lang);
        self.x = ko.observable(x);
        self.y = ko.observable(y);
        self.color = ko.observable("#000");
        self.bg = ko.observable("#fff");
        self.size = ko.observable(19);
        self.text = ko.observable("");
        self.align = ko.observable("center");
        self.fill = ko.observable(false);
        bubEx(self);
        return self;
    }
    
    function createBub(x, y) {
        var en = createOneBub(x, y, "en");
        var ru = createOneBub(x, y, "ru");
        en.sib = ru.id;
        ru.sib = en.id;
        vm.bubs.push(en);
        vm.bubs.push(ru);
        vm.id(vm.lang() === "en" ? en.id() : ru.id());
    }
    
    $(".text").on("focus", function() {
        vm.id($(this).data("id"));
    });    

    $(document).on("click", ".bub", function(e) {
        vm.id($(this).attr("id"));
        e.stopPropagation();
    });    

    $(document).on("click", ".page", function(e) {
        var sib = function (bub) {
            var id = bub.id();
            return vm.bubs().find(x => x.sib() === id);
        }

        var p = $(".page").position();
        createBub(e.pageX - Math.floor(p.left), e.pageY - Math.floor(p.top));
        
        var bubs = vm.bubs().filter(b => !b.text() && !sib(b).text());
        bubs.pop(); bubs.pop();
        bubs.forEach(b => {
            vm.bubs.remove(b);
        });
    });
    
    (function () {
        var xy = {};
        $(document).on("dragstart", ".bub", function(e) {
            vm.id($(this).attr("id"));
            xy = { x: e.offsetX, y: e.offsetY, };
            console.log(e);
        });
        
        $(document).on("dragend", ".bub", function(e) {
            var bub = vm.bub();
            bub.x(bub.x() + e.offsetX - xy.x);
            bub.y(bub.y() + e.offsetY - xy.y);
        });
    })();
    
    createBub(0,0);
    vm.id(vm.bubs()[0].id());
    //$("[data-lang=en]").focus();
    ko.applyBindings(vm);
</script>
</body>