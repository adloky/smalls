<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="jquery-2.2.4.min.js"></script>
  <script src="js/knockout-3.5.1.js"></script>
  <script src="js/knockout.mapping.js"></script>
<style>
  * { box-sizing: border-box; }
  body { margin: 0pt; margin-right: 220pt; }
  .panel { width: 220pt; margin-right: -220pt; position: fixed; right: 220pt; padding: 10pt; }
  .page { position: relative; }
  .bub { position: absolute; border: 1px solid transparent; margin: 0px; font-family: 'Comic Sans MS'; line-height: 0.85; padding: 0.2em; }
  .bub.sel { border-color: red; }
  .page { width: 1500px; height: 3000px; }
  input, textarea { margin-bottom: 5pt; font-family: 'Courier New'; }
  input { width: 40pt; }
  .text { width: 100%; height: 100pt; }
  .hidden { display: none; }
  .upper { text-transform: uppercase; }
</style>
<head>
<body>
  <div class="panel" style="z-index: 100;">
    <input type="checkbox" name="orig" data-bind="checked: orig" style=" width:20pt; " />
    <!-- ko with: bub -->
    <input class="auto-save" data-bind="value: size " style=" width: 30pt; "/>
    <input class="auto-save" data-bind="value: color "/>
    <input class="auto-save" data-bind="value: bg "/>
    <button data-bind=" click: $root.copy ">copy</button>
    <br/>
    <input class="auto-save" type="radio" name="align" value="left" data-bind="checked: align" style=" width:20pt; " />
    <input class="auto-save" type="radio" name="align" value="center" data-bind="checked: align" style=" width:20pt; " />
    <input class="auto-save" type="radio" name="align" value="right" data-bind="checked: align" style=" width:20pt; " />
    <label><input class="auto-save" type="checkbox" name="bold" data-bind="checked: bold" style=" width:20pt; " />B</label>
    <label><input class="auto-save" type="checkbox" name="fill" data-bind="checked: fill" style=" width:20pt; " />BG</label>
    <!-- /ko -->
    <textarea class="text" data-bind="css: { upper: bub().upper }, textInput: en, attr: { 'data-id': langBub('en').id }"></textarea>
    <textarea class="text" data-bind="css: { upper: bub().upper }, textInput: ru, attr: { 'data-id': langBub('ru').id }"></textarea>
    <button id="save-btn" data-bind=" click: save ">save</button>
    <button data-bind=" click: getAdapt ">adapt</button>
    <button data-bind=" click: getTranslate ">trans</button>
    <div class="result-box"></div>
  </div>
  <div style="padding: 10px;"><div class="page">
      <img data-bind="attr: { src: `bins/tt/${page()}.jpg` }" style=" position: absolute; "/>
      <img class="page-img" data-bind="css: { hidden: orig }, attr: { src: `bins/tt/${page()}-zz.jpg` }" style=" position: absolute; "/>
      <!-- ko foreach: bubs -->
      <!-- ko if: lang() === $root.lang() && !$root.orig() -->
      <pre class="bub" draggable="true" data-bind="css: { upper: upper, sel: id() == $root.id() && !$root.mode }, attr: { id: id }, text: !text() ? '&nbsp;' : text, style: { left: x() + 'px', top: y() + 'px', 'font-size': size() + 'px', color: color, 'text-shadow': sh, 'text-align': align, 'background-color': !fill() ? 'transparent' : bg(), 'font-weight': !bold() ? 'normal' : 'bold' }"></pre>
      <!-- /ko -->
      <!-- /ko -->
  </div></div>
<script>
    function guid() {
        return "10000000100040008000100000000000".replace(/[018]/g, c =>
            (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
        );
    }

    var vm = {};
    vm.bubs = ko.observableArray();
    vm.id = ko.observable();
    vm.page = ko.observable("");
    vm.orig = ko.observable(false);
    vm.allowSave = true;
    var urlPage = "002-001";
    vm.mode = "";
    
    (function() {
        var url = $(location).attr("href");
        var m = $(location).attr("href").match(/[?&]page=([0-9a-z-]*)/);
        if (m) {
            urlPage = m[1].substr(0,7);
            var sp = m[1].split('-');
            if (sp.length > 2) {
                vm.mode = sp[2];
            }
        }
        else {
            location.replace(url + "?page=" + urlPage);
        }
    })();
    
    vm.bub = ko.computed(function() {
        var id = vm.id();
        return vm.bubs().find(x => x.id() === id);
    });
    
    function langBub(lang) {
        var bub = vm.bub();
        var sibId = bub.sib();
        var sib = vm.bubs().find(x => x.id() === sibId);
        return bub.lang() === lang ? bub : sib;
    }    
    
    vm.en = ko.pureComputed({ read: function() {
        return langBub("en").text();
    }, write: function(value) {
        langBub("en").text(value);
    }});

    vm.ru = ko.pureComputed({ read: function() {
        return langBub("ru").text();
    }, write: function(value) {
        langBub("ru").text(value);
    }});

    vm.lang = ko.computed(function() {
        if (!vm.bub()) return "en";
        return vm.bub().lang();
    });
    
    vm.lang.subscribe(function(newValue) {
        vm.id(langBub(newValue).id());
    });

    function bubEx(bub) {
        bub.sh = ko.computed(function() {
            var bg = bub.bg();
            return `-1px -1px 0 ${bg}, 1px -1px 0 ${bg}, -1px 1px 0 ${bg}, 1px 1px 0 ${bg}, -2px 0px 0 ${bg}, 2px 0px 0 ${bg}`
        });
        if (bub.upper === undefined) {
            bub.upper = ko.observable(false);
        }
        return bub;
    }
    
    function createOneBub(x, y, lang) {
        var self = {};
        self.id = ko.observable(guid());
        self.lang = ko.observable(lang);
        self.x = ko.observable(x);
        self.y = ko.observable(y);
        self.color = ko.observable("#000");
        self.bg = ko.observable("#fff");
        self.size = ko.observable(16);
        self.text = ko.observable("");
        self.align = ko.observable("left");
        self.fill = ko.observable(false);
        self.bold = ko.observable(false);
        self.upper = ko.observable(true);
        bubEx(self);
        return self;
    }
    
    function createBub(x, y) {
        var en = createOneBub(x, y, "en");
        var ru = createOneBub(x, y, "ru");
        en.sib = ko.observable(ru.id());
        ru.sib = ko.observable(en.id());
        vm.bubs.push(en);
        vm.bubs.push(ru);
        vm.id(vm.lang() === "en" ? en.id() : ru.id());
    }

    vm.page.subscribe(function(page) {
        var bubs = vm.bubs().slice();
        createBub(0,0);
        bubs.forEach(x => vm.bubs.remove(x));
        vm.allowSave = false;
        $.ajax({
            url: `http://192.168.0.2/smalls/data/tt/${page}.json`
          , cache: false
        }).done(function(d) {
            d.forEach(x => {
                var xo = ko.mapping.fromJS(x);
                vm.bubs.push(bubEx(ko.mapping.fromJS(x)));
            });
            var diff = d.length > 0 ? 2 : 0;
            vm.id(vm.bubs()[vm.mode === "ru" ? diff + 1 : diff].id());
            if (d.length > 0) {
                vm.bubs.shift();
                vm.bubs.shift();
            }
        }).always(function() {
            vm.allowSave = true;
        });
    });

    vm.copy = function() {
        var en = langBub("en");
        var ru = langBub("ru");
        ru.x(en.x());
        ru.y(en.y());
        ru.color(en.color());
        ru.bg(en.bg());
        ru.size(en.size());
        ru.align(en.align());
        ru.fill(en.fill());
        ru.bold(en.bold());
    }
    
    $(".text").on("focus", function() {
        vm.id($(this).attr("data-id"));
    });    

    $(document).on("click", ".bub", function(e) {
        var id = $(this).attr("id");
        vm.id(id);
        $(`.text[data-id=${id}]`).focus();
        e.stopPropagation();
    });    

    vm.getAdapt = function() {
        var q = "=Адаптируй текст для элементарного уровня знания " +
              "английского (A2) и дай 4 варианта с переводом. Верни только результать. Текст: " + langBub("en").text();
        
        $.ajax({
            url: "http://192.168.0.2/sandbox/api/comics/gemini"
          , method: "post"
          , data: q
        }).done(function(d) {
            $(".result-box").html(d);
        });
    }

    vm.getTranslate = function() {
        var q = "=Дай 4 варианта перевод текста на русский: " + langBub("en").text();
        
        $.ajax({
            url: "http://192.168.0.2/sandbox/api/comics/gemini"
          , method: "post"
          , data: q
        }).done(function(d) {
            $(".result-box").html(d);
        });
    }
    
    $(document).on("click", ".page", function(e) {
        var sib = function (bub) {
            var id = bub.id();
            return vm.bubs().find(x => x.sib() === id);
        }

        var p = $(".page").position();
        createBub(e.pageX - Math.floor(p.left), e.pageY - Math.floor(p.top));
        
        var bubs = vm.bubs().filter(b => !b.text() && !sib(b).text());
        bubs.pop(); bubs.pop();
        bubs.forEach(b => {
            vm.bubs.remove(b);
        });
        $(`.text[data-id=${vm.id()}]`).focus();
    });

    (function () {
        var t = null;
        
        vm.save = function() {
            clearTimeout(t);
            if (!vm.allowSave)
                return;
            var cfg = { 'ignore': ["sh"] }
            var data = vm.bubs().map(x => ko.mapping.toJS(x, cfg));
            data = "=" + encodeURIComponent(JSON.stringify(data));
            $("#save-btn").text("saving");
            $.ajax({
                url: `http://192.168.0.2/sandbox/api/comics/save?path=tt/${vm.page()}.json`
              , method: "post"
              , data: data
            }).done(function() {
                $("#save-btn").text("save");
            });
        }
        
        $(document).on("change", ".auto-save", function() {
            clearTimeout(t);
            t = setTimeout(function() { vm.save(); }, 5000);
        });
        
        $(document).on("input", ".text", function() {
            clearTimeout(t);
            t = setTimeout(function() { vm.save(); }, 5000);
        });
    })();

    
    (function () {
        var xy = {};
        $(document).on("dragstart", ".bub", function(e) {
            vm.id($(this).attr("id"));
            xy = { x: e.offsetX, y: e.offsetY, };
        });
        
        $(document).on("dragend", ".bub", function(e) {
            var bub = vm.bub();
            bub.x(bub.x() + e.offsetX - xy.x);
            bub.y(bub.y() + e.offsetY - xy.y);
            $(`.text[data-id=${bub.id()}]`).focus();
        });
    })();
    
    //createBub(0,0);
    //vm.id(vm.bubs()[0].id());
    vm.page(urlPage);
    //$("[data-lang=en]").focus();
    ko.applyBindings(vm);
</script>
</body>